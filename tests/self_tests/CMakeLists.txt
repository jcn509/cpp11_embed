
# Must be set before including Cpp11Embed.cmake
set(CPP11_EMBED_EXECUTABLE_PATH Cpp11Embed)
include("${CMAKE_CURRENT_LIST_DIR}/../../cmake_integration/Cpp11Embed.cmake")

# Loosely based on this guide
# https://techtinkering.com/2013/02/12/using-dynamically-generated-header-files-with-cmake/

# We wrap cpp11_embed_generate_header in another function
# to make it a bit easier to use
add_library(AutoGeneratedHeaders INTERFACE)
set(AUTO_GENERATED_HEADERS_DIR "${CMAKE_CURRENT_BINARY_DIR}/AutoGenerated")
# Allow us to include the auto-generated headers
target_include_directories(AutoGeneratedHeaders INTERFACE "${AUTO_GENERATED_HEADERS_DIR}")
function(generate_header
    INPUT_FILE_PATH
    IDENTIFIER_NAME
    OUTPUT_FILE_NAME
)
    set(OUTPUT_FILE_PATH "${AUTO_GENERATED_HEADERS_DIR}/${OUTPUT_FILE_NAME}")

    # Replace output filename with path that includes the auto-generated
    # headers directory
    list(INSERT ARGV 2 "${OUTPUT_FILE_PATH}")
    list(REMOVE_AT ARGV 3)
    # Forward all arguments
    cpp11_embed_generate_header(${ARGV})

    # Ensure that the AutoGeneratedHeaders target is aware of all the headers
    # so that they will definitely be generated for us
    target_sources(AutoGeneratedHeaders PRIVATE "${OUTPUT_FILE_PATH}")
endfunction()

set(TEST_FILES_DIR "${CMAKE_CURRENT_LIST_DIR}/../test_files")
generate_header(
    "${TEST_FILES_DIR}/two_lines.txt"
    "k_text_header"
    "TextHeader.h"
)

generate_header(
    "${TEST_FILES_DIR}/two_lines.txt"
    "k_text_header_with_header_guard"
    "TextHeaderWithHeaderGuard.h"
    USE_HEADER_GUARD TRUE
)

generate_header(
    "${TEST_FILES_DIR}/two_lines.txt"
    "k_binary_header"
    "BinaryHeader.h"
    BINARY_MODE TRUE
)

generate_header(
    "${TEST_FILES_DIR}/two_lines.txt"
    "k_binary_header_with_header_guard"
    "BinaryHeaderWithHeaderGuard.h"
    BINARY_MODE TRUE
    USE_HEADER_GUARD TRUE
)

add_executable(Cpp11EmbedSelfTests
    Main.cpp
    SelfTests.cpp
)

target_link_libraries(Cpp11EmbedSelfTests PRIVATE
    Cpp11EmbedLib
    Catch2::Catch2
    # Make sure all the auto-generated headers get generated
    # before this target is built
    AutoGeneratedHeaders
)

catch_discover_tests(
    Cpp11EmbedSelfTests
    TEST_PREFIX "Self Test: "
)
